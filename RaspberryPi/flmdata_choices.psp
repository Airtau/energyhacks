<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Local Fluksometer data display</title>
<link href="./flmdata.css" rel="stylesheet" type="text/css">
<%
from mod_python import util
import MySQLdb
import time, datetime

db = MySQLdb.connect(host='localhost', 
		     user='root', 
		     passwd='raspberry',
	 	     db='flm')
cur = db.cursor()

form = util.FieldStorage(req)
fromDate = form.getfirst('fromDate')
fromTime = form.getfirst('fromTime')
toDate = form.getfirst('toDate')
toTime = form.getfirst('toTime')
if not (fromDate and fromTime and toDate and toTime):
	# get min and max date from database if no parameters were supplied
	# cur.execute("SELECT MIN(timestamp), MAX(timestamp) FROM flmdata;")
	# dates = cur.fetchall()
	# minDate = dates[0][0]
	# maxDate = dates[0][1]
	minDate = datetime.datetime.now()
	maxDate = minDate
	fromDate = str(minDate.date())
	fromTime = minDate.strftime("%H:%M:%S")
	toDate = str(maxDate.date())
	toTime = maxDate.strftime("%H:%M:%S")
	result = None
else:
	# get data from specified interval
	fromStr = fromDate + ' ' + fromTime
	toStr   = toDate + ' ' + toTime
	cur.execute('SELECT * FROM flmdata WHERE timestamp>=%s and timestamp<=%s;',(fromStr, toStr))
	result = cur.fetchall()
db.close()
L1 = []
L2 = []
L3 = []
PV = []

if result:
	for val in result:
		reading  = [int(time.mktime(time.strptime(str(val[1]),'%Y-%m-%d %H:%M:%S'))), 
			    int(val[2])]
		sensor = str(val[0])
		if sensor == 'L1':
			L1.append(reading)
		elif sensor == 'L2':
			L2.append(reading)
		elif sensor == 'L3':
			L3.append(reading)
		elif sensor == 'PV':
			PV.append(reading)
	L1.sort()
	L2.sort()
	L3.sort()
	PV.sort()
#
%>
<script language="javascript" type="text/javascript" src="./jquery.js"></script>
<script language="javascript" type="text/javascript" src="./jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="./jquery.flot.time.js"></script>
<script type="text/javascript">
   $(function() {
      var datasets = {
         "L1": {
             label: "L1", 
             data: <%= L1 %>
         },
         "L2": {
             label: "L2",
             data: <%= L2 %>
         },
         "L3": {
             label: "L3",
             data:  <%= L3 %>
         },
         "PV": {
             label: "PV",
             data: <%= PV %>
         }
      };

      var i = 0;
      $.each(datasets, function(key, val) {
         val.color = i;
         i++;
      });

      var choiceContainer = $("#choices");
      $.each(datasets, function(key, val) {
         choiceContainer.append("<br/><input type='checkbox' name='" + key +
              "' checked='checked' id='id" + key + "'></input>" + 
              "<label for='id" + key + "'>"
              + val.label + "</label>");
      });

      choiceContainer.find("input").click(plotAccordingToChoices);

      function plotAccordingToChoices() {
         var data = [];
         choiceContainer.find("input:checked").each(function () {
             var key = $(this).attr("name");
             if (key && datasets[key]) {
                data.push(datasets[key]);
             }
         });

         if (data.length > 0) {
            $.plot("#placeholder", data, {
              xaxis: { mode: "time" },
              yaxis: { min: 0 }
            });
         }
      }

      plotAccordingToChoices();    

  $("#footer").prepend("Flot " + $.plot.version + " &ndash; ");
});
</script>
</head>
<body>
<div id="header">
  <form method=get>
  <table>
    <tr><td></td><td>Date</td><td>Time</td></tr>
    <tr><td>From</td>
        <td><input type="date" name="fromDate" value="<%=fromDate%>"/></td>
        <td><input type="time" name="fromTime" value="<%=fromTime%>"/></td></tr>
    <tr><td>To</td>
        <td><input type="date" name="toDate" value="<%=toDate%>"/></td>
        <td><input type="time" name="toTime" value="<%=toTime%>"/></td></tr>
    <tr><td colspan=3 align=center><input type="submit" value="submit"/></td></tr>
  </table>
  </form>
  <h3>FLM recorded data</h3>
</div>
<div id="content">
  <div class="demo-container">
    <div id="placeholder" class="demo-placeholder" style="float:left; width:675px;"></div>
    <p id="choices" style="float:right; width:135px;"></p>
  </div>
  <p>FLM data in selected time interval <%=fromDate%>,<%=fromTime%> to <%=toDate%>,<%=toTime%></p>
</div>
<div id="footer">
  Copyright &copy; 2007 - 2013 IOLA and Ole Laursen; FLM adaptation Markus Gebhard
</div>
</body>
</html>
